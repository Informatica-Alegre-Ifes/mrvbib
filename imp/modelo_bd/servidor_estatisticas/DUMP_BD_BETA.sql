-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- -----------------------------------------------------
-- Schema mrvbib
-- -----------------------------------------------------
DROP SCHEMA IF EXISTS `mrvbib` ;

-- -----------------------------------------------------
-- Schema mrvbib
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `mrvbib` DEFAULT CHARACTER SET utf8 ;
USE `mrvbib` ;

-- -----------------------------------------------------
-- Table `mrvbib`.`COLETOR`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`COLETOR` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`COLETOR` (
  `COLE_CD_MAC_DISPOSITIVO` CHAR(17) NOT NULL,
  `COLE_DT_REGISTRO` DATETIME NOT NULL,
  PRIMARY KEY (`COLE_CD_MAC_DISPOSITIVO`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mrvbib`.`DADO_GPS`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`DADO_GPS` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`DADO_GPS` (
  `DADO_ID_DADO_GPS` INT NOT NULL AUTO_INCREMENT,
  `DADO_VL_LATITUDE` DECIMAL NOT NULL,
  `DADO_SG_ORIENTACAO_LATITUDE` CHAR NOT NULL,
  `DADO_VL_LONGITUDE` DECIMAL NOT NULL,
  `DADO_SG_ORIENTACAO_LONGITUDE` CHAR NOT NULL,
  `DADO_VL_VELOCIDADE` DECIMAL NOT NULL,
  `DADO_DT_CAPTURA` DATETIME NOT NULL,
  `DADO_DT_REGISTRO` DATETIME NOT NULL,
  `COLE_CD_MAC_DISPOSITIVO` CHAR(17) NOT NULL,
  PRIMARY KEY (`DADO_ID_DADO_GPS`),
  INDEX `fk_DADO_GPS_COLETOR1_idx` (`COLE_CD_MAC_DISPOSITIVO` ASC) VISIBLE,
  CONSTRAINT `fk_DADO_GPS_COLETOR1`
    FOREIGN KEY (`COLE_CD_MAC_DISPOSITIVO`)
    REFERENCES `mrvbib`.`COLETOR` (`COLE_CD_MAC_DISPOSITIVO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mrvbib`.`VEICULO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`VEICULO` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`VEICULO` (
  `VEIC_ID_VEICULO` VARCHAR(7) NOT NULL,
  `VEIC_TX_MODELO` VARCHAR(45) NOT NULL,
  `VEIC_DT_REGISTRO` DATETIME NOT NULL,
  PRIMARY KEY (`VEIC_ID_VEICULO`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mrvbib`.`LINHA`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`LINHA` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`LINHA` (
  `LINH_ID_LINHA` INT NOT NULL AUTO_INCREMENT,
  `LINH_DT_REGISTRO` DATETIME NOT NULL,
  `LINH_NM_ORIGEM` VARCHAR(45) NOT NULL,
  `LINH_NM_DESTINO` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`LINH_ID_LINHA`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mrvbib`.`HORARIO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`HORARIO` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`HORARIO` (
  `HORA_ID_HORARIO` INT NOT NULL AUTO_INCREMENT,
  `HORA_DT_REGISTRO` DATETIME NOT NULL,
  `HORA_HR_SAIDA` TIME NOT NULL,
  `LINH_ID_LINHA` INT NOT NULL,
  `VEIC_ID_VEICULO` VARCHAR(7) NOT NULL,
  PRIMARY KEY (`HORA_ID_HORARIO`),
  INDEX `fk_HORARIO_LINHA1_idx` (`LINH_ID_LINHA` ASC) VISIBLE,
  INDEX `fk_HORARIO_VEICULO1_idx` (`VEIC_ID_VEICULO` ASC) VISIBLE,
  CONSTRAINT `fk_HORARIO_LINHA1`
    FOREIGN KEY (`LINH_ID_LINHA`)
    REFERENCES `mrvbib`.`LINHA` (`LINH_ID_LINHA`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_HORARIO_VEICULO1`
    FOREIGN KEY (`VEIC_ID_VEICULO`)
    REFERENCES `mrvbib`.`VEICULO` (`VEIC_ID_VEICULO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mrvbib`.`TERMINAL`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`TERMINAL` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`TERMINAL` (
  `TERM_ID_TERMINAL` INT NOT NULL AUTO_INCREMENT,
  `TERM_DT_REGISTRO` DATETIME NOT NULL,
  `TERM_NM_NOME` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`TERM_ID_TERMINAL`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mrvbib`.`TERMINAL_HORARIO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`TERMINAL_HORARIO` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`TERMINAL_HORARIO` (
  `TERM_ID_TERMINAL` INT NOT NULL,
  `HORA_ID_HORARIO` INT NOT NULL,
  `TEHO_DT_REGISTRO` DATETIME NOT NULL,
  `TEHO_HR_SAIDA` TIME NOT NULL,
  PRIMARY KEY (`TERM_ID_TERMINAL`, `HORA_ID_HORARIO`),
  INDEX `fk_PARADA_LINHA_PARADA1_idx` (`TERM_ID_TERMINAL` ASC) VISIBLE,
  INDEX `fk_PARADA_LINHA_HORARIO1_idx` (`HORA_ID_HORARIO` ASC) VISIBLE,
  CONSTRAINT `fk_PARADA_LINHA_PARADA1`
    FOREIGN KEY (`TERM_ID_TERMINAL`)
    REFERENCES `mrvbib`.`TERMINAL` (`TERM_ID_TERMINAL`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_PARADA_LINHA_HORARIO1`
    FOREIGN KEY (`HORA_ID_HORARIO`)
    REFERENCES `mrvbib`.`HORARIO` (`HORA_ID_HORARIO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mrvbib`.`COLETOR_VEICULO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`COLETOR_VEICULO` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`COLETOR_VEICULO` (
  `COVE_DT_REGISTRO` DATETIME NOT NULL,
  `COVE_ID_COLETOR_VEICULO` INT NOT NULL AUTO_INCREMENT,
  `VEIC_ID_VEICULO` VARCHAR(7) NOT NULL,
  `COLE_CD_MAC_DISPOSITIVO` CHAR(17) NOT NULL,
  PRIMARY KEY (`COVE_ID_COLETOR_VEICULO`),
  INDEX `fk_COLETOR_VEICULO_VEICULO1_idx` (`VEIC_ID_VEICULO` ASC) VISIBLE,
  INDEX `fk_COLETOR_VEICULO_COLETOR1_idx` (`COLE_CD_MAC_DISPOSITIVO` ASC) VISIBLE,
  CONSTRAINT `fk_COLETOR_VEICULO_VEICULO1`
    FOREIGN KEY (`VEIC_ID_VEICULO`)
    REFERENCES `mrvbib`.`VEICULO` (`VEIC_ID_VEICULO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_COLETOR_VEICULO_COLETOR1`
    FOREIGN KEY (`COLE_CD_MAC_DISPOSITIVO`)
    REFERENCES `mrvbib`.`COLETOR` (`COLE_CD_MAC_DISPOSITIVO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mrvbib`.`DIAS_SEMANA`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`DIAS_SEMANA` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`DIAS_SEMANA` (
  `DIAS_ID_DIAS_SEMANA` INT NOT NULL,
  `DIAS_NM_DIA` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`DIAS_ID_DIAS_SEMANA`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mrvbib`.`HORARIO_DIAS`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`HORARIO_DIAS` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`HORARIO_DIAS` (
  `DIAS_ID_DIAS_SEMANA` INT NOT NULL,
  `HORA_ID_HORARIO` INT NOT NULL,
  PRIMARY KEY (`DIAS_ID_DIAS_SEMANA`, `HORA_ID_HORARIO`),
  INDEX `fk_HORARIO_DIAS_HORARIO1_idx` (`HORA_ID_HORARIO` ASC) VISIBLE,
  CONSTRAINT `fk_HORARIO_DIAS_DIAS_SEMANA1`
    FOREIGN KEY (`DIAS_ID_DIAS_SEMANA`)
    REFERENCES `mrvbib`.`DIAS_SEMANA` (`DIAS_ID_DIAS_SEMANA`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_HORARIO_DIAS_HORARIO1`
    FOREIGN KEY (`HORA_ID_HORARIO`)
    REFERENCES `mrvbib`.`HORARIO` (`HORA_ID_HORARIO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mrvbib`.`FERIADO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`FERIADO` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`FERIADO` (
  `FERI_ID_FERIADO` INT NOT NULL AUTO_INCREMENT,
  `FERI_DT_FERIADO` DATE NOT NULL,
  PRIMARY KEY (`FERI_ID_FERIADO`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mrvbib`.`HORARIO_FERIADO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`HORARIO_FERIADO` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`HORARIO_FERIADO` (
  `FERI_ID_FERIADO` INT NOT NULL,
  `HORA_ID_HORARIO` INT NOT NULL,
  PRIMARY KEY (`FERI_ID_FERIADO`, `HORA_ID_HORARIO`),
  INDEX `fk_HORARIO_FERIADO_HORARIO1_idx` (`HORA_ID_HORARIO` ASC) VISIBLE,
  CONSTRAINT `fk_HORARIO_FERIADO_FERIADO1`
    FOREIGN KEY (`FERI_ID_FERIADO`)
    REFERENCES `mrvbib`.`FERIADO` (`FERI_ID_FERIADO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_HORARIO_FERIADO_HORARIO1`
    FOREIGN KEY (`HORA_ID_HORARIO`)
    REFERENCES `mrvbib`.`HORARIO` (`HORA_ID_HORARIO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mrvbib`.`PONTO_PARADA`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`PONTO_PARADA` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`PONTO_PARADA` (
  `POPA_DC_PONTO_PARADA` VARCHAR(256) NOT NULL,
  `POPA_ID_PONTO_PARADA` INT NOT NULL AUTO_INCREMENT,
  `POPA_VL_LATITUDE` DECIMAL NOT NULL,
  `POPA_VL_LONGITUDE` DECIMAL NOT NULL,
  `POPA_DT_REGISTRO` DATETIME NOT NULL,
  PRIMARY KEY (`POPA_ID_PONTO_PARADA`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mrvbib`.`PONTO_PARADA_LINHA`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `mrvbib`.`PONTO_PARADA_LINHA` ;

CREATE TABLE IF NOT EXISTS `mrvbib`.`PONTO_PARADA_LINHA` (
  `LINH_ID_LINHA` INT NOT NULL,
  `POPA_ID_PONTO_PARADA` INT NOT NULL,
  `POLI_DT_REGISTRO` DATETIME NOT NULL,
  PRIMARY KEY (`LINH_ID_LINHA`, `POPA_ID_PONTO_PARADA`),
  INDEX `fk_LINHA_has_PONTO_ONIBUS_PONTO_ONIBUS1_idx` (`POPA_ID_PONTO_PARADA` ASC) VISIBLE,
  INDEX `fk_LINHA_has_PONTO_ONIBUS_LINHA1_idx` (`LINH_ID_LINHA` ASC) VISIBLE,
  CONSTRAINT `fk_LINHA_has_PONTO_ONIBUS_LINHA1`
    FOREIGN KEY (`LINH_ID_LINHA`)
    REFERENCES `mrvbib`.`LINHA` (`LINH_ID_LINHA`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_LINHA_has_PONTO_ONIBUS_PONTO_ONIBUS1`
    FOREIGN KEY (`POPA_ID_PONTO_PARADA`)
    REFERENCES `mrvbib`.`PONTO_PARADA` (`POPA_ID_PONTO_PARADA`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;


LOCK TABLES DADO_GPS WRITE, COLETOR WRITE;
INSERT INTO COLETOR(COLE_CD_MAC_DISPOSITIVO, COLE_DT_REGISTRO) VALUES ('B8-27-EB-53-8D-AC', NOW());
INSERT INTO DADO_GPS(COLE_CD_MAC_DISPOSITIVO, DADO_VL_LATITUDE, DADO_SG_ORIENTACAO_LATITUDE, DADO_VL_LONGITUDE, DADO_SG_ORIENTACAO_LONGITUDE, DADO_VL_VELOCIDADE, DADO_DT_CAPTURA, DADO_DT_REGISTRO) VALUES ('B8-27-EB-53-8D-AC',2047.675580,'S',4122.587670,'W',0.024000,'2018-10-14 22:34:08','2018-10-14 22:34:25'),('B8-27-EB-53-8D-AC',2047.675250,'S',4122.587130,'W',0.186000,'2018-10-14 22:34:59','2018-10-14 22:35:03'),('B8-27-EB-53-8D-AC',2047.674290,'S',4122.585500,'W',0.055000,'2018-10-14 22:35:36','2018-10-14 22:35:41'),('B8-27-EB-53-8D-AC',2047.674260,'S',4122.587820,'W',0.160000,'2018-10-14 22:36:14','2018-10-14 22:36:18'),('B8-27-EB-53-8D-AC',2047.676140,'S',4122.583840,'W',0.105000,'2018-10-14 22:36:52','2018-10-14 22:36:57'),('B8-27-EB-53-8D-AC',2047.675530,'S',4122.585760,'W',0.133000,'2018-10-14 22:37:30','2018-10-14 22:37:35'),('B8-27-EB-53-8D-AC',2047.678080,'S',4122.582790,'W',0.040000,'2018-10-15 01:39:15','2018-10-14 22:39:40');
UNLOCK TABLES;
/*!50003 CREATE*/ /*!50017 DEFINER=root@localhost*/ /*!50003 TRIGGER TRG_DADO_GPS_INS
BEFORE INSERT ON DADO_GPS
FOR EACH ROW
BEGIN
	DECLARE MENSAGEM_ERRO VARCHAR(128);
	DECLARE DADO_GPS_ENCONTRADO INT;
	SELECT COUNT(1) INTO DADO_GPS_ENCONTRADO FROM DADO_GPS WHERE NEW.COLE_CD_MAC_DISPOSITIVO = COLE_CD_MAC_DISPOSITIVO AND NEW.DADO_DT_CAPTURA = DADO_DT_CAPTURA;
	IF DADO_GPS_ENCONTRADO > 0 THEN
		SET MENSAGEM_ERRO = CONCAT('TRG_DADO_GPS_INS - [COLE_CD_MAC_DISPOSITIVO] E [DADO_DT_CAPTURA] JÁ EXISTEM PARA: ', NEW.COLE_CD_MAC_DISPOSITIVO, ' E ', CAST(NEW.DADO_DT_CAPTURA AS CHAR), '.');
		SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = MENSAGEM_ERRO;
	END IF;
END */;
DELIMITER ;

SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;
